openapi: 3.1.0
info:
  title: Reportheld External Protocol API
  version: 1.0.0
  description: Read-only API exposing finalized protocol data and generated snapshots for external integrations.

servers:
  - url: http://localhost:3000/api/v1

paths:
  /protocols/closed:
    get:
      summary: List closed protocols
      description: Returns metadata of finalized protocols available for external consumption.
      operationId: listClosedProtocols
      security:
        - OAuth2: [protocol.read]
        - BearerAuth: []
      responses:
        "200":
          description: Closed protocols
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ClosedProtocol"
        "401":
          description: Unauthorized
        "403":
          description: Forbidden

  /protocols/closed/{id}:
    get:
      summary: Get closed protocol metadata
      operationId: getClosedProtocol
      security:
        - OAuth2: [protocol.read]
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Closed protocol
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClosedProtocol"
        "401":
          description: Unauthorized
        "403":
          description: Forbidden
        "404":
          description: Protocol not found

  /protocols/closed/{id}/snapshot:
    get:
      summary: Get protocol snapshot
      description: Returns the computed snapshot of a finalized protocol.
      operationId: getProtocolSnapshot
      security:
        - OAuth2: [protocol.read]
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Protocol snapshot
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProtocolSnapshot"
        "401":
          description: Unauthorized
        "403":
          description: Forbidden
        "404":
          description: Snapshot not found

components:
  securitySchemes:
    OAuth2:
      type: oauth2
      flows:
        authorizationCode:
          authorizationUrl: http://localhost/oauth/authorize
          tokenUrl: http://localhost/oauth/token
          scopes:
            protocol.read: Read protocols
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ClosedProtocol:
      type: object
      required:
        - id
        - plantId
        - name
        - date
        - status
      properties:
        id:
          type: string
        plantId:
          type: string
        name:
          type: string
        template:
          type: string
        date:
          type: string
          format: date
        owner:
          type: string
        status:
          type: string
          enum:
            - closed

    ProtocolSnapshot:
      type: object
      required:
        - protocolId
        - name
        - date
        - topics
      properties:
        protocolId:
          type: string
        plantId:
          type: string
        templateName:
          $ref: "#/components/schemas/LocalizedString"
        name:
          type: string
        date:
          type: string
          format: date-time
        owner:
          type: string
        reports:
          type: array
          items:
            $ref: "#/components/schemas/Report"
        topics:
          type: array
          items:
            $ref: "#/components/schemas/ProtocolTopic"

    ProtocolTopic:
      type: object
      required:
        - name
        - items
      properties:
        name:
          $ref: "#/components/schemas/LocalizedString"
        items:
          type: array
          items:
            $ref: "#/components/schemas/ProtocolItem"

    ProtocolItem:
      type: object
      required:
        - name
        - value
      properties:
        name:
          $ref: "#/components/schemas/LocalizedString"
        value:
          description: Computed or recorded value of the item
          oneOf:
            - type: string
            - type: number
            - type: boolean
            - type: object
        status:
          type: string
          description: Evaluation result (ok, warning, failed)

    Report:
      type: object
      required:
        - reportId
      properties:
        reportId:
          type: string
        fileName:
          type: string
        language:
          type: string

    LocalizedString:
      type: object
      additionalProperties:
        type: string
      example:
        en: Inspection
        de: Inspektion
