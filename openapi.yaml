openapi: 3.1.0
info:
  title: Protocol Snapshot API
  version: 1.0.0
  description: |
    Returns generated snapshots for CLOSED protocols.
    Snapshot schema matches protocolSnapshot.json entity definition.

servers:
  - url: http://localhost:3000/api/v1
    description: Local development server

paths:
  /protocols/closed/{id}/snapshot:
    get:
      summary: Get snapshot of a closed protocol
      description: |
        Returns the generated ProtocolSnapshot for a CLOSED protocol.
        Fails if protocol is not closed or snapshot does not exist.
      operationId: getClosedProtocolSnapshot
      security:
        - OAuth2: [protocol.read]
        - BearerAuth: []

      parameters:
        - name: id
          in: path
          required: true
          description: Protocol ID
          schema:
            type: string

      responses:
        "200":
          description: Snapshot successfully retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProtocolSnapshot"
              examples:
                sampleSnapshot:
                  summary: Example snapshot
                  value:
                    protocolId: "PROT-1001"
                    powerplantId: "PLANT-01"
                    protocolBriefcaseId: "BRIEF-01"
                    templateName:
                      en: "Inspection Template"
                      de: "Inspektionsvorlage"
                    name: "Monthly Inspection"
                    date: 1700000000
                    time: "14:30"
                    status: "closed"
                    reportId: "REP-9001"
                    reports: []
                    owner: "user-123"
                    topics: []

        "401":
          description: Unauthorized

        "403":
          description: Forbidden

        "404":
          description: Snapshot not found or protocol not closed

components:
  securitySchemes:
    OAuth2:
      type: oauth2
      description: OAuth2 Authorization (Mock server for development)
      flows:
        authorizationCode:
          authorizationUrl: http://localhost:3000/oauth/authorize
          tokenUrl: http://localhost:3000/oauth/token
          scopes:
            protocol.read: Read protocol snapshots

    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ProtocolSnapshot:
      type: object
      required:
        - protocolId
        - powerplantId
        - templateName
        - name
        - owner
      properties:
        protocolId:
          type: string

        powerplantId:
          type: string

        protocolBriefcaseId:
          type: string
          nullable: true

        templateName:
          $ref: "#/components/schemas/LocalizedString"

        name:
          type: string

        date:
          type: integer
          description: UnixOffset timestamp

        time:
          type: string
          pattern: "^([0-1][0-9]|[2][0-3]):([0-5][0-9])$"
          nullable: true

        status:
          type: string
          default: "none"
          description: Protocol status enum value

        reportId:
          type: string
          nullable: true

        reports:
          type: array
          items:
            $ref: "#/components/schemas/Report"

        owner:
          type: string

        topics:
          type: array
          items:
            $ref: "#/components/schemas/ProtocolTopicSnapshot"

    LocalizedString:
      type: object
      description: Language-keyed string values
      additionalProperties:
        type: string
      example:
        en: "Inspection Template"
        de: "Inspektionsvorlage"

    Report:
      type: object
      description: Report entity (structure depends on Report definition)
      additionalProperties: true

    ProtocolTopicSnapshot:
      type: object
      description: Protocol topic snapshot structure (depends on topic definition)
      additionalProperties: true
